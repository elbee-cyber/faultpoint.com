<!doctype html><html lang="en" data-mode="dark"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Tool Release: RopView" /><meta property="og:locale" content="en" /><meta name="description" content="A technical post on my new gadget analysis framework." /><meta property="og:description" content="A technical post on my new gadget analysis framework." /><link rel="canonical" href="https://faultpoint.com/posts/binja-plugin-ropview/" /><meta property="og:url" content="https://faultpoint.com/posts/binja-plugin-ropview/" /><meta property="og:site_name" content="FaultPoint" /><meta property="og:image" content="https://faultpoint.com/assets/posts/2024-06-02/sc1.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-06-02T00:00:00-04:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://faultpoint.com/assets/posts/2024-06-02/sc1.png" /><meta property="twitter:title" content="Tool Release: RopView" /><meta name="twitter:site" content="@elbee_ez" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-06-02T00:00:00-04:00","datePublished":"2024-06-02T00:00:00-04:00","description":"A technical post on my new gadget analysis framework.","headline":"Tool Release: RopView","image":"https://faultpoint.com/assets/posts/2024-06-02/sc1.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://faultpoint.com/posts/binja-plugin-ropview/"},"url":"https://faultpoint.com/posts/binja-plugin-ropview/"}</script><title>Tool Release: RopView | FaultPoint</title><link rel="icon" type="image/png" href="/assets/img/favicons/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/svg+xml" href="/assets/img/favicons/favicon.svg"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/en.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/fp_logo_transparent.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">FaultPoint</a><p class="site-subtitle fst-italic mb-0">An assortment of vulnerability research, technical posts, and unfunny puns</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <a href="https://github.com/elbee-cyber" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/elbee_ez" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['dontopenthis','protonmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Tool Release: RopView</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Tool Release: RopView</h1><p class="post-desc fw-light mb-4">A technical post on my new gadget analysis framework.</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1717300800" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jun 2, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/assets/posts/2024-06-02/sc1.png" class="popup img-link preview-img shimmer"><img src="/assets/posts/2024-06-02/sc1.png" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/elbee_ez">Dylan Knoff</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2815 words" > <em>15 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Tool Release: RopView</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Tool Release: RopView</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><p>Technical explanations and concepts of RopView, a plugin made for BinaryNinja that does gadget analysis. This blog post describes the technical components of <a href="https://github.com/elbee-cyber/RopView">this tool</a>.</p><h1 id="table-of-contents">Table of contents</h1><ol><li><a href="#foreword">Foreword</a><li><a href="#design">Design and Components</a><li><a href="#compatibility">Compatibility</a><li><a href="#discovery">Gadget Discovery</a><li><a href="#analysis">Gadget Analyzer</a><ol><li><a href="#analysis-initialization">Initialization</a><li><a href="#analysis-context">Realtime Contextualizing</a><li><a href="#analysis-stepthru">Step-thru Analysis</a></ol><li><a href="#search">Semantic Search Filter</a><li><a href="#closing">Closing</a></ol><p><a href="/assets/posts/2024-06-02/logo.png" class="popup img-link shimmer"><img src="/assets/posts/2024-06-02/logo.png" alt="" loading="lazy"></a></p><p><a name="foreword"></a></p><h3 id="foreword"><span class="me-2">Foreword</span><a href="#foreword" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>I recently published a plugin for BinaryNinja called RopView, a gadget analysis framework that integrates emulation into ROP searching, visualizing memory side effects. For some time now, I’ve been meaning to both develop a tool capable of this, but also contribute another plugin for the BinaryNinja community and found this project to be an excellent way to do both. During the entire development process, considering what would make the exploit developer’s life easier was at the forefront, because I myself wanted to make this something I would use over similar tools when building ROP chains and could easily incorporate into my workflow. What makes RopView different from other return-oriented-programming tools however, is not its interfacing with BinaryNinja’s BinaryView. That honor goes to its powerful gadget analysis and search engine framework, which operate in consort.</p><p><a name="design"></a></p><h3 id="design-and-components"><span class="me-2">Design and Components</span><a href="#design-and-components" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>RopView is a visual UI plugin that is registered as an additional BinaryView for the current session. The layout of the plugin involves a tab system with a search filter, which remains accessible from any selected tab. The first tab, which is where the majority of time will likely be spent, is the gadget analysis display. It is made of two panes, a gadget pane, and a focused analysis pane. The gadget pane will display the entire gadget pool with user-specified filters and options applied, or gadgets that service a search request. Under the hood, the gadget pane is a QTreeWidget with scrollable items (via tab or arrow-key navigation). Additionally, double clicking on a selected gadget will navigate to its address in the primary linear BinaryView. Effects of the currently selected gadget are rendered in the analysis pane.</p><p>Analysis reports consider three focal points (only effected/clobbered memory is analyzed in each):</p><ul><li>Start state (Before analysis)<ul><li>Effects before gadget executes</ul><li>Instruction states (During analysis)<ul><li>Effects after each instruction in the gadget</ul><li>End state (After analysis)<ul><li>The memory state the gadget leaves behind</ul></ul><p><a href="/assets/posts/2024-06-02/sc1.png" class="popup img-link shimmer"><img src="/assets/posts/2024-06-02/sc1.png" alt="" loading="lazy"></a></p><p>Analysis is done through gadget emulation and certain algorithmic decisions were made in order to make the emulation as fast as possible. Moreover, analysis details are saved as ‘GadgetAnalysis’ objects, which contain the prestate, step-states, and end-state tied to a gadget address. These objects are cached and used both to resolve an analysis report if a gadget is re-selected and to assist in semantic search functionality. More technical details relevant to the analyzer itself—which will likely be the most interesting aspect of this post—will be discussed later in the relevant section.</p><p>In between the main window and the search box are two status boxes which display the gadget count (tied to the GadgetPane which could be the full pool or search results) and the search status (success or failure). The second tab contains a chain builder, which was originally going to be included with the first release, but due to certain constraints and focus on the primary functionalities, was not. In the future, gadgets from the GadgetPane will be able to be added and ordered in a list on this pane, which you can then choose or create custom script presets for.</p><p>The last tab includes configurable settings for both the standard gadget search and analysis prestates. Here register prestates can be explicitly defined and these will be used for all further analysis and semantic searches. Ideally, you’d set the registers you care about to their correct values at the time of controlled execution and further analysis will more accurately reflect what gadgets matter to you given your situation. The only other option which is out of the ordinary is the semantic depth option, which directs how many gadgets deep a query should explore for serviceable gadgets.</p><p><a href="/assets/posts/2024-06-02/sc2.png" class="popup img-link shimmer"><img src="/assets/posts/2024-06-02/sc2.png" alt="" loading="lazy"></a></p><p>One of the largest components, which I will briefly talk about but not get deep into because it is uninteresting, is the GadgetRenderer. This pane is responsible for repooling (if an option is changed such as depth, which affects the initial gadget pool) or sorting the current pool (options like bad bytes or duplicates). No matter the caller of GadgetRender, it will always consider the current configuration context when initiating and rendering a GadgetSearch. Speaking of which, the GadgetRender does, and obviously so, have a lot of call sites from various components within the tool.</p><p><a name="compatibility"></a></p><h3 id="compatibility"><span class="me-2">Compatibility</span><a href="#compatibility" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Currently this tool only supports i386 and amd64 architectures and an assert needs to be passed for the tool to be successfully initialized. Adding support for ARM and MIPS is one of the most prominent features I’d like to include in the future and will likely be the first thing worked on in future development. Obviously, as a store/load architecture many different components will have to be added to support this and it won’t be as simple as an update to the tool’s constants. For instance, delay slots will need to be considered in gadget exploration as well as how gadget searches are done entirely as both are constant-sized 4 byte instruction sets. Additionally, more gadget querying options would be ideal for both (e.g., for MIPS, queries for stackfinders, li a0, double jumps, etc.). The largest component that will need to be reworked is the GadgetSearch. What would likely require the least reconfiguration would be the GadgetAnalysis, which does diffing and analysis purely based on memory states and does not rely on static checks or heuristics.</p><p><a name="discovery"></a></p><h3 id="gadget-discovery-what-exactly-is-a-gadget"><span class="me-2">Gadget Discovery (What exactly IS a gadget?)</span><a href="#gadget-discovery-what-exactly-is-a-gadget" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>That stuff was boring and necessary to give a high-level overview of the tool’s primary functionality and design. Now onto the more interesting stuff: actually dealing with gadgets. As mentioned earlier, this tool does everything in-house and does not rely on a third party for actually finding and loading gadgets. Gadget discovery is the first task run by the GadgetRender during initialization and is responsible for finding gadgets within the current BinaryView’s data. The algorithm I am about to talk about for doing gadget searching is specifically tied to the x86 instruction set; different considerations have to be taken for instruction sets like MIPS, as what dictates gadgets differs entirely.</p><p>This section will be a valuable part of this post, as rarely do I see people actually talk about gadget searching and how we do it. Additionally, it seems like people who are just dipping their toes into binary exploitation sometimes just blindly return to addresses that do things and don’t actually understand, “what makes a gadget?”. We’ll address both of these concepts here. Gadgets in x86 (and any language for that matter) are simple. For x86, a gadget is defined as any address you can return to that decodes to a valid group of instructions and ends with an instruction that lets you control execution flow. Unlike RISC architectures, x86 instructions are not a fixed size; they can be anywhere between 1 and 16 bytes. This matters because it essentially increases the pool of candidate gadgets since you can return to misaligned addresses and walk backwards any n number of bytes and, in a sense, create code that isn’t actually user-defined.</p><p><a href="/assets/posts/2024-06-02/sc3.png" class="popup img-link shimmer"><img src="/assets/posts/2024-06-02/sc3.png" alt="" loading="lazy"></a> <a href="/assets/posts/2024-06-02/sc4.png" class="popup img-link shimmer"><img src="/assets/posts/2024-06-02/sc4.png" alt="" loading="lazy"></a></p><p>The GadgetSearch algorithm searches the binary for potential gadget sites (using regex matching) and then walks back n number of bytes (defined by depth) checking at each step if a gadget exists (valid decoding occurred). It does this until the depth is reached or a gadget-violating condition occurs such as the control instruction no longer existing or a multi-branch. This algorithm also utilizes the BinaryView’s session data to cache all gadgets, which GadgetSearch will use in the future to resolve gadgets instead of searching again (unless an option change violates the accuracy of the current gadget pool and a flush is required).</p><p>Below is a pseudo snippet of the code responsible:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="c1"># Ctrl is an architecture-tied constant in the following structure:
# (start constant, inst_len, inst regex, inst_type)
# ie: (b'\xff',2,b'\xff[\x10\x11\x12\x13\x16\x17]','call') for "call [reg]" control instruction
</span><span class="k">for</span> <span class="n">ctrl</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">__control_insn</span><span class="p">:</span>
    <span class="c1"># Start search at base each time
</span>    <span class="n">curr_site</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">__bv</span><span class="p">.</span><span class="n">start</span>

    <span class="k">while</span> <span class="n">curr_site</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c1"># Find potential gadget site
</span>        <span class="n">curr_site</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">__bv</span><span class="p">.</span><span class="nf">find_next_data</span><span class="p">(</span><span class="n">curr_site</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">curr_site</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="c1"># Saved to find next search site after depth search
</span>        <span class="n">save</span> <span class="o">=</span> <span class="n">curr_site</span>
        <span class="c1"># Confirm gadget site using regex match
</span>        <span class="k">if</span> <span class="n">re</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">self</span><span class="p">.</span><span class="n">__bv</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">curr_site</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># Depth search for gadgets and subgadgets
</span>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">depth</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">self</span><span class="p">.</span><span class="n">__bv</span><span class="p">.</span><span class="nf">get_segment_at</span><span class="p">(</span><span class="n">curr_site</span><span class="p">).</span><span class="n">executable</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">curr_site</span> <span class="o">=</span> <span class="n">save</span> <span class="o">-</span> <span class="n">i</span>
                    <span class="n">check_for_insn</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">__bv</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">curr_site</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="sh">'''</span><span class="s">
                    Checks for gadget violators
                    </span><span class="sh">'''</span>
                    <span class="nf">add_to_pool</span><span class="p">()</span>
                    <span class="nf">cache</span><span class="p">()</span>

        <span class="c1"># Next address to continue search from
</span>        <span class="n">curr_site</span> <span class="o">=</span> <span class="n">save</span> <span class="o">+</span> <span class="mi">1</span>
<span class="k">return</span> <span class="bp">True</span>
</pre></table></code></div></div><p>Essentially: find all gadget sites using regex matching, count backwards, and add the gadget to the pool if no violations occur. It really is that simple!</p><p><a name="analysis"></a></p><h3 id="gadget-analyzer"><span class="me-2">Gadget Analyzer</span><a href="#gadget-analyzer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The most attractive feature of this tool, which also acts as the backbone behind semantic searching, is the gadget analyzer. In abstract, the gadget analyzer works by creating a small, contextualized <a href="https://www.unicorn-engine.org/">Unicorn</a> emulation for the gadget, hooking instruction steps and CPU exceptions, and handling errors as they come. The method chosen of “dealing with bad things as bad things happen” was purposeful in order to keep emulations as small as possible and as fast as possible. Essentially, more stuff is added to the emulation only if it is needed and since we are dealing with a small amount of instructions and many emulations can be initialized at a time via selection scrolling, this seems like the smartest solution to a stupid problem.</p><p><a name="analysis-initialization"></a></p><h4 id="step-1-initialization"><span class="me-2">Step 1: Initialization</span><a href="#step-1-initialization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>First initialization occurs. During this phase an emulation context for the passed gadget is created. This is a “partial” context, as context building may be applied during the emulation depending on the gadget. This includes setting up registers according to the prestate configuration, creating a small code section for the gadget and creating a stack, which notably contains cyclic data. The reasoning behind this is so that it is easier to tell during analysis if a register is corrupted with stack data and derive the offset of controlled corruption using cyclic pattern matching. It is also useful for detecting corruption in general and recovering using the last, non-cyclic value. After configuring registers, mappings, setting the permissions of and writing the latter segments, and adding unicorn hooks, the emulation is ready. Note that the hooks are the most important aspect of this analysis framework. They let us do analysis, harness CPU violations, and allow for contextualizing the memory state in realtime.</p><p>There are three hooks:</p><ul><li>Code hook — executes after the current instruction is fetched and before it is executed<li>Memory violation hook — executes when unmapped memory is fetched<li>Interrupt hook — executes when a CPU interruption has occurred (simply aborts)</ul><p><a name="analysis-context"></a></p><h4 id="step-2-emulation-and-realtime-contextualizing"><span class="me-2">Step 2: Emulation and Realtime Contextualizing</span><a href="#step-2-emulation-and-realtime-contextualizing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Now that the partial gadget context is created and exceptions have been harnessed, emulation is ready to begin. One of the reasons Unicorn was chosen over other emulation frameworks is because it is lightweight and contextless. This gives us the benefit of being able to create lightweight emulations with a small amount of memory mappings. However, this also means that we are unable to emulate interrupts and syscalls and that gadget execution sometimes does not accurately reflect the true binary context.</p><p>For example, consider the following gadget: <code class="language-plaintext highlighter-rouge">mov [r14], r15 ; ret ;</code></p><p>This gadget moves the value of <code class="language-plaintext highlighter-rouge">r15</code> into the dereferenced location of <code class="language-plaintext highlighter-rouge">r14</code>. There are two issues here, one of which we can handle gracefully. Issue A: <code class="language-plaintext highlighter-rouge">r14</code> could point to memory that is statically mapped into the binary (e.g., .text, .data, .got, etc.) of which we could resolve. Issue B: Alternatively, <code class="language-plaintext highlighter-rouge">r14</code> could point to memory that is dynamic, randomly based with ASLR and purely dependent on runtime context.</p><p>The first situation we can handle in a gracefully stupid way. The second is a little harder and is not supported at this time, however I plan to allow corefile imports in the future, which will handle this scenario. In either case, both of these scenarios would result in failure as the CPU tries to fetch unmapped memory. This is where the memory violation hook comes into play. One of the steps that occurs before emulation actually starts, but as a part of the emulation function, is a check in a queue of mappings. If this list contains any mapping, it is resolved using helper functions and then dequeued. This is done by resolving the nearest page-aligned boundary that overlaps the target address. Then emulation will continue.</p><p><a href="/assets/posts/2024-06-02/diagram_resolve.png" class="popup img-link shimmer"><img src="/assets/posts/2024-06-02/diagram_resolve.png" alt="" loading="lazy"></a></p><p>The memory hook simply catches fetch violations, analyzes the dereferenced area by comparing it to mapped memory in the binary and sets an error code (which can be recoverable or non-recoverable). If the situation is recoverable via resolving then the mapping is enqueued. If the situation is not recoverable, -1 is inserted at index 0, which will direct the emulation handler to stop execution and generate an error description. Some examples of errors that are not recoverable are trying to execute mapped, non-executable memory or a null dereference. From this point on, in both cases, emulation is stopped and the handler is recursively called. The emulation handler also deals with side cases, like stack pivots, before recursion so that emulation can continue properly.</p><p><a name="analysis-stepthru"></a></p><h4 id="step-3-step-thru-analysis"><span class="me-2">Step 3: Step-thru Analysis</span><a href="#step-3-step-thru-analysis" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The code hook is responsible for doing analysis and diffing at each execution cycle. This hook is after the next instruction is fetched, but before it executes. It is responsible for both saving various components of the current memory state (in case weird corruption occurs we can recover using these components) and saving analysis. Analysis information is saved in a list, where every index corresponds to the index of an instruction in a gadget and each element represents a dictionary of the memory state at that time of execution.</p><p>For example:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>Gadget:
pop rdi ; mov rsi, 0x3 ; ret ;

Analysis:
[{rdi:'Full control'}, {rsi:3}]
</pre></table></code></div></div><p>The end state (used for both display and semantic queries) is simply derived from <code class="language-plaintext highlighter-rouge">analysis_steps[-1]</code>. Additionally, the saved previous program state is used for register diffing next time the step hook is called. At any point during emulation when the code hook is called there will exist a <code class="language-plaintext highlighter-rouge">last_program_state</code> that the current context will reference for recovery options and diffing.</p><p><a href="/assets/posts/2024-06-02/diagram_analysis.png" class="popup img-link shimmer"><img src="/assets/posts/2024-06-02/diagram_analysis.png" alt="" loading="lazy"></a></p><p><a name="search"></a></p><h3 id="semantic-search-filters"><span class="me-2">Semantic Search Filters</span><a href="#semantic-search-filters" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The search filter is unique to other tools, not just for its semantic searching capabilities, but for its handling and logical parsing of queries in general.</p><p><a href="/assets/posts/2024-06-02/semantic_search_demo.gif" class="popup img-link shimmer"><img src="/assets/posts/2024-06-02/semantic_search_demo.gif" alt="" loading="lazy"></a></p><p>The gadget pool DataFrame is derived from the gadget pool cache, which is stored in the session. The pool contains all gadgets (including duplicates), regardless of options. Options constrain what is displayed via GadgetRender and do not actually affect the gadget cache. The gadget pool DataFrame, like the cache, will contain every gadget found.</p><p>Primary queryable columns:</p><ul><li>Address (unsigned long)<li>Bytes (string)<li>Disasm (string)<li>inst_cnt (int64)<li>All registers (each an unsigned long)</ul><p>Semantic querying is done in three steps:</p><ol><li>Query translation<li>DataFrame transformation<li>DataFrame querying</ol><p>Example translation:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>Semantic search value: rax&gt;0x3b
Translation: ((rax&gt;0x3b or (rax==CONTROL_SENTINEL)) and not rax==UNINITIALIZED_SENTINEL)
</pre></table></code></div></div><p>The control sentinel value represents a register which analysis determines we have full control of (such as a popped register). We’d want to include these in the search results, since we can use these to make a register equal any value and thus it would always match any query. Additionally, we exclude the uninitialized sentinel because this sentinel value also represents unclobbered registers. After the query is built, we transform a subsection of the DataFrame by resolving analysis states from addresses in a sub-frame to the main frame until the semantic depth limit is reached.</p><p><a href="/assets/posts/2024-06-02/dataframe.png" class="popup img-link shimmer"><img src="/assets/posts/2024-06-02/dataframe.png" alt="" loading="lazy"></a></p><p>Presets are translated into static queries or queries tied to specific architecture constants.</p><p><a href="/assets/posts/2024-06-02/sc5.png" class="popup img-link shimmer"><img src="/assets/posts/2024-06-02/sc5.png" alt="" loading="lazy"></a></p><p><a name="closing"></a></p><h3 id="closing"><span class="me-2">Closing</span><a href="#closing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>That’s my tool! I hope you enjoyed this technical post describing it, which I believe was well worth writing considering the interesting algorithms and techniques that this tool adapts to do what it does. Although in retrospect, my code is not the cleanest or most optimized, I believe it is optimized enough and that some novel techniques are utilized to make it run fast with accurate results. Furthermore, this tool is an open-source plugin, so if you’d like to add a component, feature or modify existing structures, I encourage you to make a PR! I plan to actively maintain this project in the foreseeable future; specific developments I have planned can be found on the repo, but updates might be far between because of other priorities. If you’ve enjoyed this post please share it with your pwn-pals and do let me know if you’re enjoying the tool. Thank you!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/emulation/">Emulation</a>, <a href="/categories/tool/">Tool</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/unicorn/" class="post-tag no-text-decoration" >unicorn</a> <a href="/tags/pandas/" class="post-tag no-text-decoration" >pandas</a> <a href="/tags/emulation/" class="post-tag no-text-decoration" >emulation</a> <a href="/tags/tool/" class="post-tag no-text-decoration" >tool</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Tool%20Release:%20RopView%20-%20FaultPoint&url=https%3A%2F%2Ffaultpoint.com%2Fposts%2Fbinja-plugin-ropview%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Tool%20Release:%20RopView%20-%20FaultPoint&u=https%3A%2F%2Ffaultpoint.com%2Fposts%2Fbinja-plugin-ropview%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Ffaultpoint.com%2Fposts%2Fbinja-plugin-ropview%2F&text=Tool%20Release:%20RopView%20-%20FaultPoint" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/8-cves-on-the-wnr854t-junkyard/">'You Left this on the Internet?' Finding 8 Zero Days in the WNR854T for DistrictCon Junkyard</a><li class="text-truncate lh-lg"> <a href="/posts/binja-plugin-ropview/">Tool Release: RopView</a><li class="text-truncate lh-lg"> <a href="/posts/running-a-ctf-wo-lifesupport/">Running a CTF that Outlasts a Bag of Popcorn</a><li class="text-truncate lh-lg"> <a href="/posts/ransomware-and-geopolitics-for-dummies/">International Implications of Ransomware for Dummies</a><li class="text-truncate lh-lg"> <a href="/posts/battelle-magical-goat/">Feed the Magical Goat (Battelle)</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ctf/">CTF</a> <a class="post-tag btn btn-outline-primary" href="/tags/firmware-rev/">firmware rev</a> <a class="post-tag btn btn-outline-primary" href="/tags/angr/">angr</a> <a class="post-tag btn btn-outline-primary" href="/tags/aws/">aws</a> <a class="post-tag btn btn-outline-primary" href="/tags/badge/">badge</a> <a class="post-tag btn btn-outline-primary" href="/tags/chip-extraction/">chip extraction</a> <a class="post-tag btn btn-outline-primary" href="/tags/docker/">docker</a> <a class="post-tag btn btn-outline-primary" href="/tags/embedded/">embedded</a> <a class="post-tag btn btn-outline-primary" href="/tags/emulation/">emulation</a> <a class="post-tag btn btn-outline-primary" href="/tags/file-sim/">file-sim</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/running-a-ctf-wo-lifesupport/" class="btn btn-outline-primary" aria-label="Older" ><p>Running a CTF that Outlasts a Bag of Popcorn</p></a> <a href="/posts/8-cves-on-the-wnr854t-junkyard/" class="btn btn-outline-primary" aria-label="Newer" ><p>'You Left this on the Internet?' Finding 8 Zero Days in the WNR854T for DistrictCon Junkyard</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/elbee_ez">Dylan Knoff</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.4.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/ctf/">CTF</a> <a class="post-tag btn btn-outline-primary" href="/tags/firmware-rev/">firmware rev</a> <a class="post-tag btn btn-outline-primary" href="/tags/angr/">angr</a> <a class="post-tag btn btn-outline-primary" href="/tags/aws/">aws</a> <a class="post-tag btn btn-outline-primary" href="/tags/badge/">badge</a> <a class="post-tag btn btn-outline-primary" href="/tags/chip-extraction/">chip extraction</a> <a class="post-tag btn btn-outline-primary" href="/tags/docker/">docker</a> <a class="post-tag btn btn-outline-primary" href="/tags/embedded/">embedded</a> <a class="post-tag btn btn-outline-primary" href="/tags/emulation/">emulation</a> <a class="post-tag btn btn-outline-primary" href="/tags/file-sim/">file-sim</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
